-- Script for CDB
alter system set db_recovery_file_dest_size = 10G;
alter system set db_recovery_file_dest = '/opt/oracle/oradata/recovery_area' scope=spfile;
shutdown immediate
startup mount
alter database archivelog;
alter database open;
-- Should now "Database log mode: Archive Mode"
archive log list

SELECT LOG_MODE FROM V$DATABASE;

CREATE TABLESPACE logminer_tbs DATAFILE '/opt/oracle/oradata/ORCLCDB/logminer_tbs.dbf'
    SIZE 25M REUSE AUTOEXTEND ON MAXSIZE UNLIMITED;

CREATE USER c##dbzuser IDENTIFIED BY dbz
    DEFAULT TABLESPACE logminer_tbs
    QUOTA UNLIMITED ON logminer_tbs
    CONTAINER=ALL;

GRANT CREATE SESSION TO c##dbzuser CONTAINER=ALL; 
GRANT SET CONTAINER TO c##dbzuser CONTAINER=ALL; 
GRANT SELECT ON V_$DATABASE to c##dbzuser CONTAINER=ALL; 
GRANT FLASHBACK ANY TABLE TO c##dbzuser CONTAINER=ALL; 
GRANT SELECT ANY TABLE TO c##dbzuser CONTAINER=ALL; 
GRANT SELECT_CATALOG_ROLE TO c##dbzuser CONTAINER=ALL; 
GRANT EXECUTE_CATALOG_ROLE TO c##dbzuser CONTAINER=ALL; 
GRANT SELECT ANY TRANSACTION TO c##dbzuser CONTAINER=ALL; 
GRANT LOGMINING TO c##dbzuser CONTAINER=ALL; 

GRANT CREATE TABLE TO c##dbzuser CONTAINER=ALL; 
GRANT LOCK ANY TABLE TO c##dbzuser CONTAINER=ALL; 
GRANT CREATE SEQUENCE TO c##dbzuser CONTAINER=ALL; 

GRANT EXECUTE ON DBMS_LOGMNR TO c##dbzuser CONTAINER=ALL; 
GRANT EXECUTE ON DBMS_LOGMNR_D TO c##dbzuser CONTAINER=ALL; 

GRANT SELECT ON V_$LOG TO c##dbzuser CONTAINER=ALL; 
GRANT SELECT ON V_$LOG_HISTORY TO c##dbzuser CONTAINER=ALL; 
GRANT SELECT ON V_$LOGMNR_LOGS TO c##dbzuser CONTAINER=ALL; 
GRANT SELECT ON V_$LOGMNR_CONTENTS TO c##dbzuser CONTAINER=ALL; 
GRANT SELECT ON V_$LOGMNR_PARAMETERS TO c##dbzuser CONTAINER=ALL; 
GRANT SELECT ON V_$LOGFILE TO c##dbzuser CONTAINER=ALL; 
GRANT SELECT ON V_$ARCHIVED_LOG TO c##dbzuser CONTAINER=ALL; 
GRANT SELECT ON V_$ARCHIVE_DEST_STATUS TO c##dbzuser CONTAINER=ALL; 
GRANT SELECT ON V_$TRANSACTION TO c##dbzuser CONTAINER=ALL; 

GRANT SELECT ON V_$MYSTAT TO c##dbzuser CONTAINER=ALL; 
GRANT SELECT ON V_$STATNAME TO c##dbzuser CONTAINER=ALL;

CREATE TABLE C##DBZUSER.PRODUCTS (
        id NUMBER PRIMARY KEY,
        name VARCHAR2(100),
        description VARCHAR2(500),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

SELECT *
FROM C##DBZUSER.PRODUCTS;

INSERT INTO C##DBZUSER.PRODUCTS (id, name, description) VALUES (
        1,
        'Laptop',
        'High-performance laptop'
    );
COMMIT;

-- Drop because have something wrong
DROP TABLE CORE_BANKING.PRODUCTS;

-- Change to PDB
ALTER SESSION SET CONTAINER = ORCLPDB1;

CREATE USER CORE_BANKING IDENTIFIED BY qwer;
GRANT CONNECT, RESOURCE TO CORE_BANKING;
ALTER USER CORE_BANKING QUOTA UNLIMITED ON USERS;
ALTER USER CORE_BANKING DEFAULT TABLESPACE logminer_tbs;

-- 
CREATE TABLE CORE_BANKING.PRODUCTS (
        id NUMBER PRIMARY KEY,
        name VARCHAR2(100),
        description VARCHAR2(500),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

-- Move to USERS tablespace
ALTER USER CORE_BANKING DEFAULT TABLESPACE USERS;
ALTER TABLE CORE_BANKING.PRODUCTS
MOVE TABLESPACE USERS;

    
INSERT INTO CORE_BANKING.PRODUCTS (id, name, description) VALUES (
        1,
        'macBook',
        'High-performance chip'
    );
COMMIT;


show con_name;




-- Core Customer (with XMLTYPE columns for flexible structures)
CREATE TABLE CORE_BANKING.CUSTOMER_SEGMENT (
    ID       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CODE     VARCHAR2(50) UNIQUE NOT NULL,   -- e.g. RETAIL, CORPORATE, VIP, STUDENT
    NAME     VARCHAR2(200),
    STATUS   VARCHAR2(20) DEFAULT 'ACTIVE' CHECK (STATUS IN ('ACTIVE','INACTIVE'))
);

CREATE TABLE CORE_BANKING.CUSTOMER (
    ID      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CUSTOMER_NUMBER  VARCHAR2(100) NOT NULL,
    FIRST_NAME       VARCHAR2(100) NOT NULL,
    LAST_NAME        VARCHAR2(100) NOT NULL,
    DATE_OF_BIRTH    DATE NOT NULL,
    EMAIL            VARCHAR2(150) UNIQUE,
    SEGMENT_ID       NUMBER,
    ADDRESS_XML      XMLTYPE,   -- customer addresses
    CONTACT_XML      XMLTYPE,   -- customer contact details
    KYC_XML          XMLTYPE,   -- KYC documents
    PROFITABILITY    NUMBER,
    STATUS           VARCHAR2(20) DEFAULT 'ACTIVE' CHECK (STATUS IN ('ACTIVE','INACTIVE','CLOSED','BLOCKED')),
    CREATED_AT       TIMESTAMP DEFAULT SYSTIMESTAMP,
    CREATED_BY       VARCHAR2(50),
    UPDATED_AT       TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPDATED_BY       VARCHAR2(50),
    CONSTRAINT FK_CUSTOMER_SEGMENT FOREIGN KEY (SEGMENT_ID) REFERENCES CORE_BANKING.CUSTOMER_SEGMENT(ID)
);

CREATE INDEX IDX_CUSTOMER_SEGMENT ON CORE_BANKING.CUSTOMER(SEGMENT_ID);
CREATE INDEX IDX_CUSTOMER_NAME_UPPER ON CORE_BANKING.CUSTOMER (UPPER(FIRST_NAME || ' ' || LAST_NAME));

-- XML Indexes
CREATE INDEX IDX_CUSTOMER_ADDRESS_XML ON CORE_BANKING.CUSTOMER (EXTRACTVALUE(ADDRESS_XML, '/Addresses/Address/City'));
CREATE INDEX IDX_CUSTOMER_CONTACT_XML ON CORE_BANKING.CUSTOMER (EXTRACTVALUE(CONTACT_XML, '/Contacts/Contact/Number'));
CREATE INDEX IDX_CUSTOMER_KYC_TYPE_XML ON CORE_BANKING.CUSTOMER (EXTRACTVALUE(CONTACT_XML, '/KYC/Document/Type'));
CREATE INDEX IDX_CUSTOMER_KYC_NUMBER_XML ON CORE_BANKING.CUSTOMER (EXTRACTVALUE(CONTACT_XML, '/KYC/Document/Number'));

-- Core Account
CREATE TABLE CORE_BANKING.ACCOUNT_TYPE (
    TYPE_CODE        VARCHAR2(20) PRIMARY KEY,     -- e.g. SAVINGS, LOAN
    DESCRIPTION      VARCHAR2(100) NOT NULL,
    CURRENCY         VARCHAR2(10) DEFAULT 'USD',
    STATUS           VARCHAR2(20) DEFAULT 'ACTIVE' CHECK (STATUS IN ('ACTIVE','INACTIVE'))
);

CREATE TABLE CORE_BANKING.BRANCH (
    ID        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME      VARCHAR2(150),
    LOCATION         VARCHAR2(255),
    STATUS           VARCHAR2(20) DEFAULT 'ACTIVE'
                     CHECK (STATUS IN ('ACTIVE','INACTIVE'))
);

CREATE TABLE CORE_BANKING.ACCOUNT (
    ID               NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CUSTOMER_ID      NUMBER NOT NULL,
    ACCOUNT_NUMBER   VARCHAR2(20) UNIQUE NOT NULL,
    TYPE_CODE        VARCHAR2(20) NOT NULL,
    BALANCE          NUMBER(15,2) DEFAULT 0,
    BRANCH_ID        NUMBER,
    STATUS           VARCHAR2(20) DEFAULT 'ACTIVE' CHECK (STATUS IN ('ACTIVE','INACTIVE','CLOSED','FROZEN')),
    CREATED_AT       TIMESTAMP DEFAULT SYSTIMESTAMP,
    CREATED_BY       VARCHAR2(50),
    UPDATED_AT       TIMESTAMP,
    UPDATED_BY       VARCHAR2(50),
    CONSTRAINT FK_ACCOUNT_CUSTOMER FOREIGN KEY (CUSTOMER_ID) REFERENCES CORE_BANKING.CUSTOMER (ID),
    CONSTRAINT FK_ACCOUNT_TYPE FOREIGN KEY (TYPE_CODE) REFERENCES CORE_BANKING.ACCOUNT_TYPE (TYPE_CODE),
    CONSTRAINT FK_ACCOUNT_BRANCH FOREIGN KEY (BRANCH_ID) REFERENCES CORE_BANKING.BRANCH (ID)
);

-- Indexes for ACCOUNT
CREATE INDEX IDX_ACCOUNT_CUSTOMER ON CORE_BANKING.ACCOUNT(CUSTOMER_ID);
CREATE INDEX IDX_ACCOUNT_BRANCH ON CORE_BANKING.ACCOUNT(BRANCH_ID);

-- Core Transaction
CREATE TABLE CORE_BANKING.TRANSACTION_TYPE (
    TYPE_CODE        VARCHAR2(20) PRIMARY KEY,
    DESCRIPTION      VARCHAR2(100)
);


CREATE TABLE CORE_BANKING.TRANSACTION (
    ID               NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ACCOUNT_ID       NUMBER NOT NULL,
    TYPE_CODE        VARCHAR2(20),
    AMOUNT           NUMBER(15,2) NOT NULL,
    CURRENCY         VARCHAR2(10) DEFAULT 'USD',
    REMARK           VARCHAR2(255),
    CREATED_AT       TIMESTAMP DEFAULT SYSTIMESTAMP,
    CREATED_BY       VARCHAR2(50),
    UPDATED_AT       TIMESTAMP,
    UPDATED_BY       VARCHAR2(50),
    CONSTRAINT FK_TX_ACCOUNT FOREIGN KEY (ACCOUNT_ID) REFERENCES CORE_BANKING.ACCOUNT(ID),
    CONSTRAINT FK_TX_TYPE_CODE FOREIGN KEY (TYPE_CODE) REFERENCES CORE_BANKING.TRANSACTION_TYPE(TYPE_CODE)
);

-- Indexes for BANK_TRANSACTION
CREATE INDEX IDX_TX_ACCOUNT ON CORE_BANKING.TRANSACTION(ACCOUNT_ID);
CREATE INDEX IDX_TX_DATE ON CORE_BANKING.TRANSACTION(CREATED_AT);